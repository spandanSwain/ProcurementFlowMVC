@model ProcurementFlow.Models.TranscationConsole.TransactionConsoleViewModel;

@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Transaction Console";
}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div class="card shadow-sm p-3 mt-3">
    <h3 class="fw-bold mb-3">Transaction Console</h3>
    <hr />

    <h6 class="fw-bold mt-3">Requisition List</h6>
    <div style="max-height: 250px; overflow-y: auto;">
        @if (Model.RequisitionTransactions != null && Model.RequisitionTransactions.Any()){
            <table class="table table-sm table-bordered text-center align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].ItemName)</th>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].ItemDescription)</th>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].UOM)</th>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].Quantity)</th>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].Price)</th>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].Urgent)</th>
                        <th>@Html.DisplayNameFor(m => m.RequisitionTransactions![0].Status)</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    @for(int i=0; i<Model.RequisitionTransactions.Count;i++){
                        var item = Model.RequisitionTransactions[i];                        
                        <tr>
                            <td>@item.ItemName</td>
                            <td>@item.ItemDescription</td>
                            <td>@item.UOM</td>
                            <td>@item.Quantity</td>
                            <td>@item.Price</td>
                            <td>
                                <span class="badge @(item.Urgent == "Yes" ? "bg-danger" : "bg-warning")">@item.Urgent</span>
                            </td>
                            <td>
                                <span class="badge @(item.Status == "Approved" ? "bg-success" : "bg-danger")">@item.Status</span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary view-dtls" data-index="@i">
                                    <i class="bi bi-eye me-1"></i> View Details
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="mt-2 @(Model.RequisitionTransactions.TotalPages > 1 ? "d-flex justify-content-between":"d-none")">
                @{
                    var prevDisabled = !Model.RequisitionTransactions.HasPreviousPage ? "disabled" : "";
                    var nextDisabled = !Model.RequisitionTransactions.HasNextPage ? "disabled" : "";
                }
                <a asp-action="TransactionConsole"
                   asp-route-page="@(Model.RequisitionTransactions.PageIndex - 1)"
                   class="btn btn-outline-dark @prevDisabled">Previous</a>

                <span>Page @Model.RequisitionTransactions.PageIndex of @Model.RequisitionTransactions.TotalPages</span>

                <a asp-action="TransactionConsole"
                   asp-route-page="@(Model.RequisitionTransactions.PageIndex + 1)"
                   class="btn btn-outline-dark @nextDisabled">Next</a>
            </div>
        }
        else{
            <p class="text-muted">No results found</p>
        }
    </div>

    <div id="detailsCard" class="mt-4" style="display:none;">
        <div class="card border-0 shadow-sm p-3 bg-light">
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" id="closeDetails"></button>
            <h5 class="fw-bold mb-3">
                <i class="bi bi-info-circle me-2"></i>Requisition Details
            </h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <p><strong>Item Name:</strong> <span id="d_itemName"></span></p>
                    <p><strong>Description:</strong> <span id="d_itemDescription"></span></p>
                    <p><strong>UOM:</strong> <span id="d_uom"></span></p>
                    <p><strong>Quantity:</strong> <span id="d_quantity"></span></p>
                    <p><strong>Changed by:</strong> <span id="d_change"></span></p>
                    <p><strong>Changed on:</strong> <span id="d_change_on"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Price:</strong> ₹<span id="d_price"></span></p>
                    <p><strong>Delivery Address:</strong> <span id="d_addrr"></span></p>
                    <p><strong>Delivery Location:</strong> <span id="d_loc"></span></p>
                    <p><strong>Requested Date:</strong> <span id="d_requestedDate"></span></p>
                    <p><strong>Status:</strong> <span id="d_status" class="badge"></span></p>
                    <p><strong>Urgent:</strong> <span id="d_urgent" class="badge"></span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 text-start">
        <a asp-action="Index" asp-controller="@Context.Session.GetString("Redirect")" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back
        </a>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
@using System.Text.Json
<script>
    var requisitions = JSON.parse('@Html.Raw(JsonSerializer.Serialize(Model.RequisitionTransactions))');
    $(".view-dtls").on("click", function (){
        var idx = $(this).data("index");
        var data = requisitions[idx];

        $("#d_itemName").text(data.ItemName);
        $("#d_itemDescription").text(data.ItemDescription);
        $("#d_uom").text(data.UOM);
        $("#d_quantity").text(data.Quantity);
        $("#d_price").text(data.Price);
        let Reqdate = new Date(data.RequestedDate);
        let Actiondate =new Date(data.ActionTakenOn);
        let options = {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        };
        $("#d_requestedDate").text(Reqdate.toLocaleString('en-GB', options));

        $("#d_status").text(data.Status)
            .removeClass("bg-primary bg-danger")
            .addClass(data.Status === "Approved" ? "bg-success" : "bg-danger");

        $("#d_urgent").text(data.Urgent)
            .removeClass("bg-primary bg-danger")
            .addClass(data.Urgent === "Yes" ? "bg-danger" : "bg-warning");

        $("#d_change").text(data.ActionBy);
        $("#d_change_on").text(Actiondate.toLocaleString('en-GB', {day: 'numeric',month: 'short', year: 'numeric'}));
        $("#d_addrr").text(data.DeliveryAddress);
        $("#d_loc").text(data.DeliveryLocation);

        $("#detailsCard").slideDown();
    });

    $("#closeDetails").on("click", function(){
        $("#detailsCard").slideUp();
    });
</script>